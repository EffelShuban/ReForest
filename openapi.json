openapi: 3.0.0
info:
  title: Tree Sponsorship API
  description: API for managing tree adoptions, forest plots, and sponsor transactions.
  version: 1.0.0

servers:
  - url: https:localhost:8080/
    description: Development server

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

paths:
  # --- AUTH SERVICE ---
  /auth/login:
    post:
      summary: User Login
      tags: [Auth]
      responses:
        200:
          description: Returns JWT token and user role.

  /auth/register:
    post:
      summary: User Registration
      tags: [Auth]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                full_name: { type: string }
                email: { type: string, format: email }
                password: { type: string, format: password }
      responses:
        201:
          description: User registered successfully.
          
  # --- TREE & PLOT MANAGEMENT ---
  /species:
    get:
      summary: List available tree species
      tags: [Tree Management]
      responses:
        200:
          description: A list of species.

  /species/{id}:
    get:
      summary: Get species details by ID
      tags: [Tree Management]
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string, format: uuid }
      responses:
        200:
          description: Detailed information about the species.
        404:
          description: Species not found.

  /admin/species:
    post:
      summary: Create a new tree species
      security: [{ bearerAuth: [] }]
      tags: [Tree Management]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name: { type: string }
                scientific_name: { type: string }
                description: { type: string }
                adoption_price: { type: number }
      responses:
        201:
          description: Species created.

  /admin/species/{id}:
    put:
      summary: Update a tree species
      security: [{ bearerAuth: [] }]
      tags: [Tree Management]
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string, format: uuid }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name: { type: string }
                scientific_name: { type: string }
                description: { type: string }
                adoption_price: { type: number }
      responses:
        200:
          description: Species updated successfully.
        404:
          description: Species not found.
    delete:
      summary: Delete a tree species
      security: [{ bearerAuth: [] }]
      tags: [Tree Management]
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string, format: uuid }
      responses:
        204:
          description: Species deleted successfully.
        404:
          description: Species not found.

  /plots:
    get:
      summary: List forest plots
      tags: [Tree Management]
      responses:
        200:
          description: A list of plots with available space.

  /plots/{id}:
    get:
      summary: Get plot details by ID
      tags: [Tree Management]
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string, format: uuid }
      responses:
        200:
          description: Detailed information about the plot.
        404:
          description: Plot not found.

  /admin/plots:
    post:
      summary: Create a new forest plot
      security: [{ bearerAuth: [] }]
      tags: [Tree Management]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name: { type: string }
                location: { type: string }
                capacity: { type: integer }
      responses:
        201:
          description: Plot created.

  /admin/plots/{id}:
    put:
      summary: Update a forest plot
      security: [{ bearerAuth: [] }]
      tags: [Tree Management]
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string, format: uuid }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name: { type: string }
                location: { type: string }
                capacity: { type: integer }
      responses:
        200:
          description: Plot updated successfully.
        404:
          description: Plot not found.
    delete:
      summary: Delete a forest plot
      security: [{ bearerAuth: [] }]
      tags: [Tree Management]
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string, format: uuid }
      responses:
        204:
          description: Plot deleted successfully.
        404:
          description: Plot not found.

  /trees:
    get:
      summary: List all trees
      tags: [Tree Management]
      responses:
        200:
          description: List of all trees.
    post:
      summary: Adopt a new tree
      security: [{ bearerAuth: [] }]
      tags: [Tree Management]
      description: Logic checks balance. If insufficient, returns a payment link.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                species_id: { type: string, format: uuid }
                plot_id: { type: string, format: uuid }
                custom_name: { type: string }
      responses:
        201:
          description: Tree adopted successfully.
        402:
          description: Payment Required (Balance low, Xendit invoice generated).

  /trees/{id}:
    get:
      summary: Get tree details
      tags: [Tree Management]
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string, format: uuid }
      responses:
        200:
          description: Tree details.
        404:
          description: Tree not found.
    
  /trees/admin/{id}:
    put:
      summary: Update tree details
      security: [{ bearerAuth: [] }]
      tags: [Tree Management]
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string, format: uuid }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                custom_name: { type: string }
                species_id: { type: string, format: uuid }
                plot_id: { type: string, format: uuid }
      responses:
        200:
          description: Tree updated successfully.
        404:
          description: Tree not found.
    delete:
      summary: Delete a tree
      security: [{ bearerAuth: [] }]
      tags: [Tree Management]
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string, format: uuid }
      responses:
        204:
          description: Tree deleted successfully.
        404:
          description: Tree not found.

  /trees/{id}/logs:
    get:
      summary: Get tree maintenance/growth logs
      tags: [Tree Management]
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string }
      responses:
        200:
          description: List of growth and care logs.
    post:
      summary: Add a log entry for a tree
      security: [{ bearerAuth: [] }]
      tags: [Tree Management]
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string, format: uuid }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                title: { type: string }
                description: { type: string }
                image_url: { type: string }
      responses:
        201:
          description: Log entry created.

  /logs/{id}:
    put:
      summary: Update a log entry
      security: [{ bearerAuth: [] }]
      tags: [Tree Management]
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string, format: uuid }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                title: { type: string }
                description: { type: string }
                image_url: { type: string }
      responses:
        200:
          description: Log updated successfully.
        404:
          description: Log not found.
    delete:
      summary: Delete a log entry
      security: [{ bearerAuth: [] }]
      tags: [Tree Management]
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string, format: uuid }
      responses:
        204:
          description: Log deleted successfully.
        404:
          description: Log not found.

  # --- TRANSACTION & BALANCE ---
  /transactions:
    post:
      summary: Create a manual transaction
      security: [{ bearerAuth: [] }]
      tags: [Finance]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                user_id: { type: string, format: uuid }
                amount: { type: number }
                type: { type: string, enum: ["DEPOSIT", "WITHDRAWAL", "PURCHASE"] }
      responses:
        201:
          description: Transaction created.

  /wallet/topup:
    post:
      summary: Deposit funds to wallet
      security: [{ bearerAuth: [] }]
      tags: [Finance]
      responses:
        200:
          description: Returns Xendit payment URL.

  /wallet/webhook:
    post:
      summary: Xendit Payment Callback
      tags: [Finance]
      description: Updates sponsor balance upon successful payment.
      responses:
        200:
          description: Webhook received.

  /wallet/balance:
    get:
      summary: Get user's current wallet balance
      security: [{ bearerAuth: [] }]
      tags: [Finance]
      responses:
        200:
          description: Current wallet balance.
          content:
            application/json:
              schema:
                type: object
                properties:
                  balance: { type: number }

  /transaction/history:
    get:
      summary: View transaction history
      security: [{ bearerAuth: [] }]
      tags: [Finance]
      responses:
        200:
          description: List of all financial movements.

  /jobs/biweekly-maintenance:
    post:
      summary: Trigger biweekly care log creation
      tags: [Tree Management]
      responses:
        200:
          description: Logs generated for pending trees.

  /notify/send-reminder:
    post:
      summary: Send expiration reminder
      tags: [Notifier]
      description: Internal endpoint used to trigger a "1-hour left" alert.
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                transaction_id: { type: string, format: uuid }
                sponsor_email: { type: string }
                payment_url: { type: string }
      responses:
        200:
          description: Notification sent successfully.

  /notify/payment-success:
    post:
      summary: Send payment success notification
      tags: [Notifier]
      description: Internal endpoint to notify user of successful payment.
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                transaction_id: { type: string, format: uuid }
                sponsor_email: { type: string }
                amount: { type: number }
      responses:
        200:
          description: Notification sent successfully.

  /jobs/payment-expiry-check:
    post:
      summary: Scan for payments expiring in 1 hour
      tags: [Finance]
      description: >
        Scheduled job (Cron) that finds transactions where status is PENDING 
        and expiration is in T-60 minutes.
      responses:
        200:
          description: Job completed; triggered reminders for matching transactions.
        204:
          description: No transactions currently requiring reminders.